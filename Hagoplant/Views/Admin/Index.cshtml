@model Hagoplant.ViewModels.AdminDashboardVm
@using System.Linq
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hago Tree - Quản trị hệ thống</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts: Francois One -->
    <link href="https://fonts.googleapis.com/css2?family=Francois+One&display=swap" rel="stylesheet">
    <!-- EasyMDE (Markdown Editor) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde@2.20.0/dist/easymde.min.css">
    <script src="https://cdn.jsdelivr.net/npm/easymde@2.20.0/dist/easymde.min.js"></script>

    <!-- Marked: Markdown -> HTML -->
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>

    <!-- DOMPurify: sanitize HTML để chống XSS -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.3.1/dist/purify.min.js"></script>

    <style>
        body {
            font-family: 'Francois One', sans-serif;
            background-color: #f8f5f0;
            color: #333;
        }
        .text-primary-custom {
            color: #579a62 !important;
        }
        .bg-primary-custom {
            background-color: #579a62 !important;
        }
        .btn-primary-custom {
            background-color: #579a62;
            border-color: #579a62;
            color: white;
        }
        .btn-primary-custom:hover {
            background-color: #478152;
            border-color: #478152;
        }
        .btn-secondary-custom {
            background-color: transparent;
            border-color: #579a62;
            color: #579a62;
        }
        .btn-secondary-custom:hover {
            background-color: rgba(87, 154, 98, 0.1);
        }

        /* Header Admin */
        .admin-header {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            height: 80px;
        }
        .admin-logo {
            width: 50px;
            height: 50px;
        }

        /* Sidebar Admin */
        .admin-sidebar {
            background: linear-gradient(180deg, #2d2d2d 0%, #1a1a1a 100%);
            color: white;
            min-height: calc(100vh - 80px);
            box-shadow: 3px 0 15px rgba(0, 0, 0, 0.1);
        }
        .admin-sidebar .nav-link {
            color: #ddd;
            padding: 12px 20px;
            border-radius: 8px;
            margin: 5px 10px;
            transition: all 0.3s ease;
        }
        .admin-sidebar .nav-link:hover {
            background-color: rgba(87, 154, 98, 0.2);
            color: white;
            transform: translateX(5px);
        }
        .admin-sidebar .nav-link.active {
            background-color: #579a62;
            color: white;
        }
        .admin-sidebar .nav-link i {
            width: 25px;
        }

        /* Content area */
        .admin-content {
            padding: 30px;
            min-height: calc(100vh - 80px);
            background-color: #f8f5f0;
        }

        /* Cards */
        .admin-card {
            border: 2px solid #d4af37;
            background-color: #ffffff;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .admin-card-header {
            background: linear-gradient(to right, #579a62, #6bbf7a);
            color: white;
            padding: 15px 20px;
            border-bottom: 2px solid #d4af37;
        }

        /* Stats Cards */
        .stat-card {
            text-align: center;
            padding: 25px 15px;
            border-radius: 15px;
            color: white;
            margin-bottom: 20px;
        }
        .stat-card.revenue { background: linear-gradient(135deg, #4e54c8, #8f94fb); }
        .stat-card.users { background: linear-gradient(135deg, #11998e, #38ef7d); }
        .stat-card.products { background: linear-gradient(135deg, #f46b45, #eea849); }
        .stat-card.orders { background: linear-gradient(135deg, #8E2DE2, #4A00E0); }
        .stat-card i { font-size: 2.5rem; margin-bottom: 15px; opacity: 0.9; }
        .stat-card .number { font-size: 2.2rem; font-weight: bold; margin-bottom: 5px; }
        .stat-card .label { font-size: 0.9rem; opacity: 0.9; }

        /* Table search bar */
        .table-search {
            max-width: 300px;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        .empty-state i {
            font-size: 4rem;
            color: #ddd;
            margin-bottom: 20px;
        }

        @@media (max-width: 768px) {
            .admin-content { padding: 15px; }
            .stat-card .number { font-size: 1.8rem; }
            .table-search { max-width: 100%; margin-bottom: 15px; }
        }
        /* Markdown preview trong modal blog */
        .markdown-preview {
            background: #fff;
            border: 1px solid #e8e8e8;
            border-radius: 12px;
            padding: 14px;
            min-height: 420px;
            overflow: auto;
        }

            .markdown-preview img {
                max-width: 100%;
                height: auto;
            }

            .markdown-preview pre {
                background: #0f172a;
                color: #f1f5f9;
                padding: 12px;
                border-radius: 10px;
                overflow: auto;
            }

            .markdown-preview code {
                font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            }

        /* === BLOG MODALS: giới hạn chiều cao để modal luôn cuộn được === */
        #addBlogModal .modal-dialog,
        #editBlogModal .modal-dialog {
            max-width: 1140px;
        }

        #addBlogModal .modal-content,
        #editBlogModal .modal-content {
            height: 92vh;
        }

        #addBlogModal .modal-body,
        #editBlogModal .modal-body {
            overflow-y: auto;
        }

        /* footer luôn hiện, không bị trôi mất khi scroll */
        #addBlogModal .modal-footer,
        #editBlogModal .modal-footer {
            position: sticky;
            bottom: 0;
            background: #fff;
            z-index: 10;
            border-top: 1px solid #eee;
        }

        /* === EasyMDE/CodeMirror: KHÓA chiều cao để bài dài scroll bên trong editor === */
        #addBlogModal .EasyMDEContainer .CodeMirror,
        #editBlogModal .EasyMDEContainer .CodeMirror {
            height: 52vh; /* bạn có thể tăng/giảm */
            max-height: 52vh;
        }

        #addBlogModal .EasyMDEContainer .CodeMirror-scroll,
        #editBlogModal .EasyMDEContainer .CodeMirror-scroll {
            max-height: 52vh;
        }

        /* Preview bạn đã có overflow:auto rồi, ok */


    </style>
</head>
<body>

    <!-- Header -->
    <header class="admin-header d-flex align-items-center px-4">
        <img src="https://via.placeholder.com/50" alt="Logo" class="admin-logo me-3">
        <h4 class="text-white mb-0">Hago Tree - Quản trị</h4>
        <div class="ms-auto">
            <i class="fas fa-user-circle text-white fs-3"></i>
        </div>
    </header>

    <div class="container-fluid p-0">
        <div class="row g-0">
            <!-- Sidebar -->
            <div class="col-lg-2 col-md-3">
                <div class="admin-sidebar p-3">
                    <ul class="nav flex-column">
                        <li class="nav-item"><a class="nav-link active" href="#dashboard"><i class="fas fa-home"></i> Tổng quan</a></li>
                        <li class="nav-item"><a class="nav-link" href="#users"><i class="fas fa-users"></i> Người dùng</a></li>
                        <li class="nav-item"><a class="nav-link" href="#products"><i class="fas fa-tree"></i> Sản phẩm</a></li>
                        <li class="nav-item"><a class="nav-link" href="#orders"><i class="fas fa-shopping-cart"></i> Đơn hàng</a></li>
                        <li class="nav-item"><a class="nav-link" href="#blog"><i class="fas fa-blog"></i> Blog</a></li>
                        <li class="nav-item"><a class="nav-link" href="#reports"><i class="fas fa-chart-bar"></i> Báo cáo</a></li>
                    </ul>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-lg-10 col-md-9">
                <div class="admin-content">

                    <!-- Dashboard -->
                    <section id="dashboard" class="section-content">
                        <h2 class="text-primary-custom mb-4">Tổng quan hệ thống</h2>
                        <div class="row mb-5">
                            <div class="col-md-3"><div class="stat-card revenue"><i class="fas fa-money-bill-wave"></i><div class="number">0 ₫</div><div class="label">Doanh thu tháng</div></div></div>
                            <div class="col-md-3"><div class="stat-card users"><i class="fas fa-users"></i><div class="number">0</div><div class="label">Người dùng</div></div></div>
                            <div class="col-md-3"><div class="stat-card products"><i class="fas fa-tree"></i><div class="number">0</div><div class="label">Sản phẩm</div></div></div>
                            <div class="col-md-3"><div class="stat-card orders"><i class="fas fa-shopping-cart"></i><div class="number">0</div><div class="label">Đơn hàng</div></div></div>
                        </div>

                        <div class="row">
                            <div class="col-md-8 mb-4">
                                <div class="admin-card">
                                    <div class="admin-card-header"><h5 class="mb-0">Doanh thu 6 tháng gần nhất</h5></div>
                                    <div class="card-body p-4">
                                        <div class="empty-state"><i class="fas fa-chart-line"></i><p>Chưa có dữ liệu doanh thu</p></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-4">
                                <div class="admin-card">
                                    <div class="admin-card-header"><h5 class="mb-0">Phân loại sản phẩm</h5></div>
                                    <div class="card-body p-4">
                                        <div class="empty-state"><i class="fas fa-chart-pie"></i><p>Chưa có dữ liệu sản phẩm</p></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section id="users" class="section-content d-none">
                        @using System.Security.Claims
                        @{
                            var currentUserIdStr = User.FindFirstValue(ClaimTypes.NameIdentifier);
                            Guid.TryParse(currentUserIdStr, out var currentUserId);

                            var users = Model?.Users;
                        }
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2 class="text-primary-custom mb-0">Quản lý người dùng</h2>
                            <!-- BỎ nút Thêm người dùng -->
                        </div>

                        <div class="admin-card">
                            <div class="admin-card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-users me-2"></i>Danh sách người dùng</h5>
                                <input id="userSearch" type="text" class="form-control table-search" placeholder="Tìm kiếm theo tên, email...">
                            </div>

                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="width:90px;">ID</th>
                                                <th>Họ tên</th>
                                                <th>Email</th>
                                                <th>Số điện thoại</th>
                                                <th style="min-width:160px;">Ngày đăng ký</th>
                                                <th style="min-width:110px;">Thao tác</th>
                                            </tr>
                                        </thead>

                                        <tbody id="usersTbody">
                                            @if (users == null || users.Count == 0)
                                            {
                                                <tr>
                                                    <td colspan="6">
                                                        <div class="empty-state py-5">
                                                            <i class="fas fa-users"></i>
                                                            <p class="mb-0">Chưa có người dùng nào</p>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                            else
                                            {
                                                @foreach (var u in users)
                                                {
                                                    var isSelf = (currentUserId != Guid.Empty && u.Id == currentUserId);

                                                    <tr class="user-row"
                                                        data-id="@u.Id"
                                                        data-name="@(u.FullName ?? "")"
                                                        data-email="@(u.Email ?? "")">
                                                        <td class="text-muted small">@u.Id</td>
                                                        <td class="fw-semibold">@(string.IsNullOrWhiteSpace(u.FullName) ? "-" : u.FullName)</td>
                                                        <td>@(string.IsNullOrWhiteSpace(u.Email) ? "-" : u.Email)</td>
                                                        <td>@(string.IsNullOrWhiteSpace(u.Phone) ? "-" : u.Phone)</td>
                                                        <td class="text-muted">
                                                            @u.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                                                        </td>
                                                        <td>
                                                            <form method="post"
                                                                  action="/Admin/DeleteUser"
                                                                  class="d-inline"
                                                                  onsubmit="return confirm('Xóa người dùng này? Hành động có thể không hoàn tác.');">
                                                                @Html.AntiForgeryToken()
                                                                <input type="hidden" name="id" value="@u.Id" />
                                                                <button type="submit"
                                                                        class="btn btn-sm btn-outline-danger"
                                                                        @(isSelf ? "disabled" : "")>
                                                                    <i class="fas fa-trash"></i>
                                                                </button>
                                                            </form>
                                                        </td>
                                                    </tr>
                                                }

                                            }
                                        </tbody>

                                    </table>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Quản lý Sản phẩm -->
                    <section id="products" class="section-content d-none">

                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2 class="text-primary-custom mb-0">Quản lý sản phẩm</h2>
                            <button class="btn btn-primary-custom"
                                    data-bs-toggle="modal"
                                    data-bs-target="#addProductModal">
                                <i class="fas fa-plus me-2"></i>Thêm sản phẩm
                            </button>
                        </div>

                        <div class="admin-card">
                            <div class="admin-card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-tree me-2"></i>Danh sách sản phẩm
                                </h5>
                                <input id="productSearch"
                                       type="text"
                                       class="form-control table-search"
                                       placeholder="Tìm theo tên, slug, id..." />
                            </div>

                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="min-width:180px;">ID</th>
                                                <th style="width:90px;">Ảnh</th>
                                                <th style="min-width:220px;">Tên sản phẩm</th>
                                                <th style="min-width:200px;">Slug</th>
                                                <th style="min-width:120px;">Giá</th>
                                                <th style="min-width:120px;">Giá sale</th>
                                                <th style="min-width:110px;">Đang bán</th>
                                                <th style="min-width:110px;">Nổi bật</th>
                                                <th style="min-width:170px;">Ngày tạo</th>
                                                <th style="min-width:140px;">Thao tác</th>
                                            </tr>
                                        </thead>

                                        <tbody>
                                            @if (Model?.Products == null || Model.Products.Count == 0)
                                            {
                                                <tr>
                                                    <td colspan="10">
                                                        <div class="empty-state py-5 text-center">
                                                            <i class="fas fa-tree"></i>
                                                            <p class="mb-0">Chưa có sản phẩm nào</p>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                            else
                                            {
                                                foreach (var p in Model.Products)
                                                {
                                                    <tr class="product-row"
                                                        data-id="@p.Id"
                                                        data-name="@p.Name">
                                                        <td class="text-muted small">@p.Id</td>

                                                        <td>
                                                            @if (!string.IsNullOrWhiteSpace(p.ImageUrl))
                                                            {
                                                                <img src="@p.ImageUrl"
                                                                     class="rounded"
                                                                     style="width:60px;height:60px;object-fit:cover;" />
                                                            }
                                                            else
                                                            {
                                                                <span class="text-muted small">No image</span>
                                                            }
                                                </td>

                                                <td class="fw-semibold">@p.Name</td>
                                                <td class="text-muted">@p.Slug</td>

                                                <td>@string.Format("{0:N0}", p.Price)</td>
                                                <td>
                                                    @(p.SalePrice.HasValue
                                                                                                        ? string.Format("{0:N0}", p.SalePrice.Value)
                                                                                                        : "-")
                                                        </td>

                                                        <td>
                                                            @if (p.IsActive)
                                                            {
                                                                <span class="badge bg-success">Active</span>
                                                            }
                                                            else
                                                            {
                                                                <span class="badge bg-secondary">Off</span>
                                                            }
                                                        </td>

                                                        <td>
                                                            @if (p.IsFeatured)
                                                            {
                                                                <span class="badge bg-warning text-dark">Yes</span>
                                                            }
                                                            else
                                                            {
                                                                <span class="badge bg-secondary">No</span>
                                                            }
                                                        </td>

                                                        <td class="text-muted">
                                                            @p.CreatedAt.ToLocalTime()
                                                            .ToString("dd/MM/yyyy HH:mm")
                                                        </td>

                                                        <td>
                                                            <!-- Edit -->
                                                            <button type="button"
                                                                    class="btn btn-sm btn-outline-primary btn-edit-product"
                                                                    data-bs-toggle="modal"
                                                                    data-bs-target="#editProductModal"
                                                                    data-id="@p.Id"
                                                                    data-name="@p.Name"
                                                                    data-slug="@p.Slug"
                                                                    data-description="@p.Description"
                                                                    data-price="@p.Price"
                                                                    data-saleprice="@(p.SalePrice?.ToString() ?? "")"
                                                                    data-imageurl="@p.ImageUrl"
                                                                    data-isactive="@p.IsActive"
                                                                    data-isfeatured="@p.IsFeatured">
                                                                <i class="fas fa-pen"></i>
                                                            </button>

                                                            <!-- Delete -->
                                                            <form method="post"
                                                                  action="/Admin/DeleteProduct"
                                                                  class="d-inline"
                                                                  onsubmit="return confirm('Xóa sản phẩm này?');">
                                                                @Html.AntiForgeryToken()
                                                                <input type="hidden" name="id" value="@p.Id" />
                                                                <button type="submit"
                                                                        class="btn btn-sm btn-outline-danger ms-1">
                                                                    <i class="fas fa-trash"></i>
                                                                </button>
                                                            </form>
                                                        </td>
                                                    </tr>
                                                }
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </section>



                    <!-- Quản lý Đơn hàng -->
                    <section id="orders" class="section-content d-none">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2 class="text-primary-custom mb-0">Quản lý đơn hàng</h2>
                            <button class="btn btn-primary-custom" disabled>
                                <i class="fas fa-plus me-2"></i>Thêm đơn hàng (tính năng sắp có)
                            </button>
                        </div>

                        <div class="admin-card">
                            <div class="admin-card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Danh sách đơn hàng</h5>
                                <input type="text" class="form-control table-search" placeholder="Tìm kiếm theo mã đơn, khách hàng...">
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Mã đơn</th>
                                                <th>Khách hàng</th>
                                                <th>Ngày đặt</th>
                                                <th>Tổng tiền</th>
                                                <th>Trạng thái</th>
                                                <th>Thao tác</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td colspan="6">
                                                    <div class="empty-state py-5">
                                                        <i class="fas fa-shopping-cart"></i>
                                                        <p>Chưa có đơn hàng nào</p>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Quản lý Blog -->
                    <section id="blog" class="section-content d-none">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2 class="text-primary-custom mb-0">Quản lý bài viết blog</h2>
                            <button class="btn btn-primary-custom" data-bs-toggle="modal" data-bs-target="#addBlogModal">
                                <i class="fas fa-plus me-2"></i>Viết bài mới
                            </button>
                        </div>

                        <div class="admin-card">
                            <div class="admin-card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-blog me-2"></i>Danh sách bài viết</h5>
                                <input id="blogSearch" type="text" class="form-control table-search"
                                       placeholder="Tìm theo tiêu đề, slug, id...">
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle">
                                        <thead class="table-light">
                                            <tr>
                                                <th>ID</th>
                                                <th>Tiêu đề</th>
                                                <th>Tác giả</th>
                                                <th>Ngày đăng</th>
                                                <th>Lượt xem</th>
                                                <th>Thao tác</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @if (Model?.BlogPosts == null || Model.BlogPosts.Count == 0)
                                            {
                                                <tr>
                                                    <td colspan="6">
                                                        <div class="empty-state py-5">
                                                            <i class="fas fa-blog"></i>
                                                            <p>Chưa có bài viết nào</p>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                            else
                                            {
                                                foreach (var b in Model.BlogPosts)
                                                {
                                                    <tr>
                                                        <td class="text-muted small">@b.Id</td>
                                                        <td class="fw-semibold">@b.Title</td>
                                                        <td>@(b.AuthorUserId?.ToString() ?? "-")</td>
                                                        <td class="text-muted">@((b.PublishedAt ?? b.CreatedAt).ToLocalTime().ToString("dd/MM/yyyy HH:mm"))</td>
                                                        <td>@b.ViewCount</td>
                                                        <td>
                                                            <!-- Edit -->
                                                            <button type="button"
                                                                    class="btn btn-sm btn-outline-primary btn-edit-blog"
                                                                    data-bs-toggle="modal"
                                                                    data-bs-target="#editBlogModal"
                                                                    data-id="@b.Id">
                                                                <i class="fas fa-pen"></i>
                                                            </button>

                                                            <!-- Delete -->
                                                            <form method="post"
                                                                  action="/Admin/DeleteBlogPost"
                                                                  class="d-inline"
                                                                  onsubmit="return confirm('Xóa bài viết này?');">
                                                                @Html.AntiForgeryToken()
                                                                <input type="hidden" name="id" value="@b.Id" />
                                                                <button type="submit" class="btn btn-sm btn-outline-danger ms-1">
                                                                    <i class="fas fa-trash"></i>
                                                                </button>
                                                            </form>

                                                            <!-- JSON data cho JS đọc (tránh data-* bị vỡ do HTML dài) -->
                                                            <script type="application/json" id="blog-data-@b.Id">
                                                                @Html.Raw(System.Text.Json.JsonSerializer.Serialize(new {
                                                                    id = b.Id,
                                                                                                                        title = b.Title,
                                                                                                                        slug = b.Slug,
                                                                                                                        excerpt = b.Excerpt,
                                                                                                                        status = b.Status,
                                                                                                                        coverImageUrl = b.CoverImageUrl,
                                                                                                                        contentHtml = b.ContentHtml
                                                                                                                }))
                                                    </script>
                                                </td>

                                                    </tr>
                                                }
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Báo cáo -->
                    <section id="reports" class="section-content d-none">
                        <h2 class="text-primary-custom mb-4">Báo cáo & Thống kê</h2>
                        <div class="row">
                            <div class="col-12">
                                <div class="admin-card">
                                    <div class="admin-card-header"><h5 class="mb-0">Thống kê chi tiết</h5></div>
                                    <div class="card-body p-5">
                                        <div class="empty-state">
                                            <i class="fas fa-chart-bar"></i>
                                            <p>Chưa có dữ liệu để hiển thị báo cáo</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                </div>
            </div>
        </div>
    </div>
    <!-- Modal Thêm sản phẩm -->
    <div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary-custom text-white">
                    <h5 class="modal-title" id="addProductModalLabel">
                        <i class="fas fa-plus me-2"></i>Thêm sản phẩm
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Đóng"></button>
                </div>

                <form method="post"
                      action="@Url.Action("CreateProduct", "Admin")"
                      id="addProductForm"
                      novalidate>
                    @Html.AntiForgeryToken()

                    <div class="modal-body">
                        <input type="hidden" name="Id" value="" />
                        <input type="hidden" name="ImageUrl" id="productImageUrlHidden" />
                        <input type="hidden" name="CreatedAt" value="" />

                        <div class="row g-3">
                            <div class="col-md-8">
                                <label class="form-label">Tên sản phẩm <span class="text-danger">*</span></label>
                                <input type="text"
                                       class="form-control"
                                       id="productName"
                                       name="Name"
                                       required
                                       maxlength="200"
                                       placeholder="Ví dụ: Cây Trầu Bà Leo Cột" />
                                <div class="invalid-feedback">Vui lòng nhập tên sản phẩm.</div>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Slug <span class="text-danger">*</span></label>
                                <input type="text"
                                       class="form-control"
                                       id="productSlug"
                                       name="Slug"
                                       required
                                       maxlength="250"
                                       placeholder="cay-trau-ba-leo-cot" />
                                <div class="invalid-feedback">Vui lòng nhập slug.</div>
                                <small class="text-muted">Tự tạo từ tên, bạn có thể sửa lại.</small>
                            </div>

                            <div class="col-12">
                                <label class="form-label">Mô tả</label>
                                <textarea class="form-control"
                                          id="productDescription"
                                          name="Description"
                                          rows="4"
                                          placeholder="Mô tả ngắn về sản phẩm..."></textarea>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Giá gốc (Price) <span class="text-danger">*</span></label>
                                <input type="number"
                                       class="form-control"
                                       id="productPrice"
                                       name="Price"
                                       required
                                       step="0.01"
                                       min="0"
                                       placeholder="0" />
                                <div class="invalid-feedback">Vui lòng nhập giá hợp lệ.</div>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Giá sale (SalePrice)</label>
                                <input type="number"
                                       class="form-control"
                                       id="productSalePrice"
                                       name="SalePrice"
                                       step="0.01"
                                       min="0"
                                       placeholder="(không bắt buộc)" />
                                <small class="text-muted">Có thể để trống.</small>
                            </div>

                            <!-- Trạng thái: KHÔNG hidden boolean -->
                            <div class="col-md-4">
                                <label class="form-label">Trạng thái</label>
                                <div class="d-flex gap-3 align-items-center mt-1">
                                    <div class="form-check">
                                        <input class="form-check-input"
                                               type="checkbox"
                                               id="productIsActive"
                                               name="IsActive"
                                               value="true"
                                               checked />
                                        <label class="form-check-label" for="productIsActive">Đang bán</label>
                                    </div>

                                    <div class="form-check">
                                        <input class="form-check-input"
                                               type="checkbox"
                                               id="productIsFeatured"
                                               name="IsFeatured"
                                               value="true" />
                                        <label class="form-check-label" for="productIsFeatured">Nổi bật</label>
                                    </div>
                                </div>
                            </div>

                            <!-- Upload ảnh -> Cloudinary (JS upload và set ImageUrl hidden) -->
                            <div class="col-md-8">
                                <label class="form-label">Ảnh sản phẩm</label>
                                <input type="file"
                                       class="form-control"
                                       id="productImageFile"
                                       accept="image/*" />
                                <small class="text-muted">Chọn ảnh để upload lên Cloudinary; link sẽ tự lưu vào database.</small>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Xem trước ảnh</label>
                                <div class="border rounded p-2 bg-light d-flex align-items-center justify-content-center" style="height: 120px;">
                                    <img id="productImagePreview" alt="preview" style="max-height:110px;max-width:100%;display:none;" />
                                    <span id="productImageEmpty" class="text-muted">Chưa có ảnh</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-primary-custom">
                            <i class="fas fa-save me-2"></i>Lưu sản phẩm
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Sửa sản phẩm -->
    <div class="modal fade" id="editProductModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary-custom text-white">
                    <h5 class="modal-title"><i class="fas fa-pen me-2"></i>Sửa sản phẩm</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <form method="post"
                      action="@Url.Action("UpdateProduct", "Admin")"
                      id="editProductForm"
                      novalidate>
                    @Html.AntiForgeryToken()

                    <input type="hidden" name="id" id="editId" />

                    <!-- JS sẽ set URL ảnh mới vào đây (nếu upload ảnh mới) -->
                    <input type="hidden" name="ImageUrl" id="editImageUrlHidden" />

                    <!-- Luôn giữ URL ảnh hiện tại để server có thể giữ lại nếu không upload mới -->
                    <input type="hidden" name="ExistingImageUrl" id="editExistingImageUrl" />

                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-8">
                                <label class="form-label">Tên sản phẩm *</label>
                                <input type="text" class="form-control" id="editName" name="Name" required />
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Slug *</label>
                                <input type="text" class="form-control" id="editSlug" name="Slug" required />
                            </div>

                            <div class="col-12">
                                <label class="form-label">Mô tả</label>
                                <textarea class="form-control" id="editDescription" name="Description" rows="4"></textarea>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Giá *</label>
                                <input type="number" class="form-control" id="editPrice" name="Price" step="0.01" min="0" required />
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Giá sale</label>
                                <input type="number" class="form-control" id="editSalePrice" name="SalePrice" step="0.01" min="0" />
                            </div>

                            <!-- Trạng thái: KHÔNG hidden boolean -->
                            <div class="col-md-4">
                                <label class="form-label">Trạng thái</label>
                                <div class="d-flex gap-3 align-items-center mt-1">
                                    <div class="form-check">
                                        <input class="form-check-input"
                                               type="checkbox"
                                               id="editIsActive"
                                               name="IsActive"
                                               value="true" />
                                        <label class="form-check-label" for="editIsActive">Đang bán</label>
                                    </div>

                                    <div class="form-check">
                                        <input class="form-check-input"
                                               type="checkbox"
                                               id="editIsFeatured"
                                               name="IsFeatured"
                                               value="true" />
                                        <label class="form-check-label" for="editIsFeatured">Nổi bật</label>
                                    </div>
                                </div>
                            </div>

                            <!-- Chọn ảnh mới (nếu cần). JS upload và set editImageUrlHidden -->
                            <div class="col-md-8">
                                <label class="form-label">Đổi ảnh sản phẩm (nếu cần)</label>
                                <input type="file"
                                       class="form-control"
                                       id="editImageFile"
                                       accept="image/*" />
                                <small class="text-muted">Nếu không chọn ảnh mới, hệ thống sẽ giữ ảnh hiện tại.</small>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Xem trước ảnh</label>
                                <div class="border rounded p-2 bg-light d-flex align-items-center justify-content-center" style="height: 120px;">
                                    <img id="editImgPreview" alt="preview" style="max-height:110px;max-width:100%;display:none;" />
                                    <span id="editImgEmpty" class="text-muted">Chưa có ảnh</span>
                                </div>
                            </div>

                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-primary-custom">
                            <i class="fas fa-save me-2"></i>Cập nhật
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- Modal Viết bài Blog -->
    <div class="modal fade" id="addBlogModal" tabindex="-1" aria-labelledby="addBlogModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary-custom text-white">
                    <h5 class="modal-title" id="addBlogModalLabel">
                        <i class="fas fa-pen-nib me-2"></i>Viết bài blog mới
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Đóng"></button>
                </div>

                <form method="post" action="/Admin/CreateBlogPost" id="addBlogForm" novalidate>
                    @Html.AntiForgeryToken()

                    <!-- DB của bạn cần ContentHtml, CoverImageUrl, PublishedAt,... -->
                    <input type="hidden" name="ContentHtml" id="blogContentHtml" />
                    <input type="hidden" name="CoverImageUrl" id="blogCoverImageUrl" />
                    <input type="hidden" name="PublishedAt" id="blogPublishedAt" />

                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-8">
                                <label class="form-label">Tiêu đề <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="blogTitle" name="Title" required maxlength="250"
                                       placeholder="Ví dụ: 5 cách chọn cây để bàn giúp tập trung" />
                                <div class="invalid-feedback">Vui lòng nhập tiêu đề.</div>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Slug <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="blogSlug" name="Slug" required maxlength="250"
                                       placeholder="5-cach-chon-cay-de-ban-giup-tap-trung" />
                                <small class="text-muted">Tự tạo từ tiêu đề, bạn có thể sửa.</small>
                                <div class="invalid-feedback">Vui lòng nhập slug.</div>
                            </div>

                            <div class="col-md-8">
                                <label class="form-label">Tóm tắt (Excerpt)</label>
                                <textarea class="form-control" id="blogExcerpt" name="Excerpt" rows="2"
                                          placeholder="Tóm tắt ngắn 1–2 câu... (có thể để trống, hệ thống tự sinh)"></textarea>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Trạng thái</label>
                                <select class="form-select" id="blogStatus" name="Status">
                                    <option value="draft" selected>Nháp (draft)</option>
                                    <option value="published">Đăng ngay (published)</option>
                                    <option value="archived">Lưu trữ (archived)</option>
                                </select>
                                <small class="text-muted">Nếu “Đăng ngay”, hệ thống tự set thời gian đăng.</small>
                            </div>

                            <div class="col-md-8">
                                <label class="form-label">Ảnh bìa</label>
                                <input type="file" class="form-control" id="blogCoverFile" accept="image/*">
                                <small class="text-muted">Chọn ảnh để upload lên Cloudinary; link sẽ lưu vào DB.</small>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Xem trước ảnh bìa</label>
                                <div class="border rounded p-2 bg-light d-flex align-items-center justify-content-center" style="height: 120px;">
                                    <img id="blogCoverPreview" alt="cover" style="max-height:110px;max-width:100%;display:none;" />
                                    <span id="blogCoverEmpty" class="text-muted">Chưa có ảnh</span>
                                </div>
                            </div>

                            <hr class="my-2">

                            <div class="col-lg-6">
                                <label class="form-label">Nội dung (Markdown) <span class="text-danger">*</span></label>
                                <textarea id="blogMarkdown" name="ContentMarkdown"></textarea>
                                <small class="text-muted">Bạn viết Markdown. Khi lưu, hệ thống chuyển thành HTML và gửi về backend.</small>
                            </div>

                            <div class="col-lg-6">
                                <label class="form-label">Xem trước (HTML)</label>
                                <div id="blogPreview" class="markdown-preview">
                                    <div class="text-muted">Preview sẽ hiển thị tại đây.</div>
                                </div>
                            </div>

                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-primary-custom">
                            <i class="fas fa-save me-2"></i>Lưu bài viết
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
        <!-- Modal Sửa bài Blog -->
        <div class="modal fade" id="editBlogModal" tabindex="-1" aria-labelledby="editBlogModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header bg-primary-custom text-white">
                        <h5 class="modal-title" id="editBlogModalLabel">
                            <i class="fas fa-pen me-2"></i>Sửa bài blog
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Đóng"></button>
                    </div>

                    <form method="post" action="/Admin/UpdateBlogPost" id="editBlogForm" novalidate>
                        @Html.AntiForgeryToken()

                        <input type="hidden" name="id" id="editBlogId" />
                        <input type="hidden" name="ContentHtml" id="editBlogContentHtml" />
                        <input type="hidden" name="CoverImageUrl" id="editBlogCoverImageUrl" />

                        <div class="modal-body">
                            <div class="row g-3">
                                <div class="col-md-8">
                                    <label class="form-label">Tiêu đề <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="editBlogTitle" name="Title" required maxlength="250">
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label">Slug <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="editBlogSlug" name="Slug" required maxlength="250">
                                    <small class="text-muted">Tự tạo từ tiêu đề, bạn có thể sửa.</small>
                                </div>

                                <div class="col-md-8">
                                    <label class="form-label">Tóm tắt (Excerpt)</label>
                                    <textarea class="form-control" id="editBlogExcerpt" name="Excerpt" rows="2"
                                              placeholder="Tóm tắt ngắn 1–2 câu..."></textarea>
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label">Trạng thái</label>
                                    <select class="form-select" id="editBlogStatus" name="Status">
                                        <option value="draft">Nháp (draft)</option>
                                        <option value="published">Đăng (published)</option>
                                        <option value="archived">Lưu trữ (archived)</option>
                                    </select>
                                </div>

                                <div class="col-md-8">
                                    <label class="form-label">Đổi ảnh bìa (nếu cần)</label>
                                    <input type="file" class="form-control" id="editBlogCoverFile" accept="image/*">
                                    <small class="text-muted">Nếu không chọn ảnh mới, hệ thống sẽ giữ ảnh bìa hiện tại.</small>

                                    <div class="mt-2">
                                        <button type="button" class="btn btn-sm btn-outline-secondary" id="btnClearEditCover">
                                            Xóa ảnh bìa
                                        </button>
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label">Xem trước ảnh bìa</label>
                                    <div class="border rounded p-2 bg-light d-flex align-items-center justify-content-center" style="height: 120px;">
                                        <img id="editBlogCoverPreview" alt="cover" style="max-height:110px;max-width:100%;display:none;" />
                                        <span id="editBlogCoverEmpty" class="text-muted">Chưa có ảnh</span>
                                    </div>
                                </div>

                                <hr class="my-2">

                                <div class="col-lg-6">
                                    <label class="form-label">Nội dung (Markdown) <span class="text-danger">*</span></label>
                                    <textarea id="editBlogMarkdown"></textarea>
                                    <small class="text-muted">Bài cũ lưu HTML, hệ thống sẽ cố gắng chuyển về text để bạn chỉnh sửa.</small>
                                </div>

                                <div class="col-lg-6">
                                    <label class="form-label">Xem trước (HTML)</label>
                                    <div id="editBlogPreview" class="markdown-preview">
                                        <div class="text-muted">Preview sẽ hiển thị tại đây.</div>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                            <button type="submit" class="btn btn-primary-custom">
                                <i class="fas fa-save me-2"></i>Lưu thay đổi
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        (() => {
          "use strict";

          // ====== Cloudinary unsigned config ======
          const CLOUD_NAME = "dksk0yoma";
          const UPLOAD_PRESET = "hago_unsigned_products";

          // ====== Helpers ======
          const $  = (sel, root = document) => root.querySelector(sel);
          const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

          function makeSlug(text) {
            return (text || "")
              .toString().trim().toLowerCase()
              .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
              .replace(/đ/g, "d")
              .replace(/[^a-z0-9\s-]/g, "")
              .replace(/\s+/g, "-")
              .replace(/-+/g, "-")
              .replace(/^-+|-+$/g, "");
          }

          function setPreviewUrl(url, imgEl, emptyEl) {
            if (!imgEl || !emptyEl) return;
            const u = (url || "").trim();

            if (!u) {
              imgEl.style.display = "none";
              imgEl.removeAttribute("src");
              emptyEl.style.display = "inline";
              return;
            }

            imgEl.src = u;
            imgEl.style.display = "block";
            emptyEl.style.display = "none";

            imgEl.onerror = () => {
              imgEl.style.display = "none";
              imgEl.removeAttribute("src");
              emptyEl.style.display = "inline";
            };
          }

          function bindFilePreview(fileInput, imgEl, emptyEl) {
            if (!fileInput || !imgEl || !emptyEl) return;

            fileInput.addEventListener("change", () => {
              const f = fileInput.files && fileInput.files[0];
              if (!f || !f.type?.startsWith("image/")) {
                setPreviewUrl("", imgEl, emptyEl);
                return;
              }
              imgEl.src = URL.createObjectURL(f);
              imgEl.style.display = "block";
              emptyEl.style.display = "none";
            });
          }

          async function uploadToCloudinaryUnsigned(file, publicIdOptional) {
            const endpoint = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`;
            const fd = new FormData();
            fd.append("file", file);
            fd.append("upload_preset", UPLOAD_PRESET);
            if (publicIdOptional) fd.append("public_id", publicIdOptional);

            const res = await fetch(endpoint, { method: "POST", body: fd });
            const data = await res.json().catch(() => ({}));

            if (!res.ok) {
              const msg = data?.error?.message || "Upload Cloudinary thất bại.";
              throw new Error(msg);
            }
            if (!data.secure_url) throw new Error("Không nhận được secure_url từ Cloudinary.");
            return data.secure_url;
          }

          function wireUploadBeforeSubmit({ formId, fileInputId, hiddenUrlId, nameForPublicId }) {
            const form = document.getElementById(formId);
            const fileInput = document.getElementById(fileInputId);
            const hiddenUrl = document.getElementById(hiddenUrlId);
            if (!form || !fileInput || !hiddenUrl) return;

            form.addEventListener("submit", async (e) => {
              const file = fileInput.files && fileInput.files[0];
              if (!file) return;

              if (!file.type?.startsWith("image/")) {
                e.preventDefault();
                alert("Vui lòng chọn đúng định dạng ảnh (image/*).");
                return;
              }

              e.preventDefault();

              const submitBtn = form.querySelector('button[type="submit"]');
              const oldHtml = submitBtn ? submitBtn.innerHTML : null;

              if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = "Đang tải ảnh...";
              }

              try {
                const base = nameForPublicId ? makeSlug(nameForPublicId()) : "product";
                const publicId = `${base}-${Date.now()}`;
                const url = await uploadToCloudinaryUnsigned(file, publicId);

                hiddenUrl.value = url;
                form.submit();
              } catch (err) {
                console.error(err);
                alert(err?.message || "Upload ảnh thất bại. Vui lòng thử lại.");
                if (submitBtn) {
                  submitBtn.disabled = false;
                  submitBtn.innerHTML = oldHtml;
                }
              }
            });
          }

          document.addEventListener("DOMContentLoaded", () => {
            // ===== Sidebar sections =====
            function showSection(sectionId) {
              $$(".section-content").forEach(s => s.classList.add("d-none"));
              const section = document.getElementById(sectionId);
              if (section) section.classList.remove("d-none");

              $$(".admin-sidebar .nav-link").forEach(l => l.classList.remove("active"));
              const activeLink = $(`.admin-sidebar .nav-link[href="#${sectionId}"]`);
              if (activeLink) activeLink.classList.add("active");
            }

            $$(".admin-sidebar .nav-link").forEach(link => {
              link.addEventListener("click", (e) => {
                e.preventDefault();
                const id = (link.getAttribute("href") || "").replace("#", "");
                if (id) showSection(id);
              });
            });

            // ===== Product: auto slug (ADD) =====
            const nameInput = $("#productName");
            const slugInput = $("#productSlug");
            let slugTouched = false;

            if (slugInput) {
              slugInput.addEventListener("input", () => {
                slugTouched = slugInput.value.trim().length > 0;
              });
            }
            if (nameInput && slugInput) {
              nameInput.addEventListener("input", () => {
                if (!slugTouched) slugInput.value = makeSlug(nameInput.value);
              });
            }

            // ===== Product: preview file =====
            bindFilePreview($("#productImageFile"), $("#productImagePreview"), $("#productImageEmpty"));
            bindFilePreview($("#editImageFile"), $("#editImgPreview"), $("#editImgEmpty"));

            // ===== Product: fill EDIT modal =====
            $$(".btn-edit-product").forEach(btn => {
              btn.addEventListener("click", () => {
                const d = btn.dataset;

                $("#editId").value = d.id || "";
                $("#editName").value = d.name || "";
                $("#editSlug").value = d.slug || "";
                $("#editDescription").value = d.description || "";
                $("#editPrice").value = d.price || "0";
                $("#editSalePrice").value = d.saleprice || "";

                $("#editIsActive").checked = (d.isactive === "True" || d.isactive === "true");
                $("#editIsFeatured").checked = (d.isfeatured === "True" || d.isfeatured === "true");

                const currentUrl = d.imageurl || "";
                if ($("#editExistingImageUrl")) $("#editExistingImageUrl").value = currentUrl;
                if ($("#editImageUrlHidden")) $("#editImageUrlHidden").value = currentUrl;

                const editFile = $("#editImageFile");
                if (editFile) editFile.value = "";

                setPreviewUrl(currentUrl, $("#editImgPreview"), $("#editImgEmpty"));
              });
            });

            // ===== Product: upload before submit =====
            wireUploadBeforeSubmit({
              formId: "addProductForm",
              fileInputId: "productImageFile",
              hiddenUrlId: "productImageUrlHidden",
              nameForPublicId: () => ($("#productSlug")?.value || $("#productName")?.value || "product")
            });

            wireUploadBeforeSubmit({
              formId: "editProductForm",
              fileInputId: "editImageFile",
              hiddenUrlId: "editImageUrlHidden",
              nameForPublicId: () => ($("#editSlug")?.value || $("#editName")?.value || "product")
            });

            // ===== Product: search filter =====
            const productSearch = document.getElementById("productSearch");
            if (productSearch) {
              const rows = document.querySelectorAll("tr.product-row");
              const normalize = (s) => (s || "").toString().trim().toLowerCase();

              function filterProducts() {
                const q = normalize(productSearch.value);
                rows.forEach(row => {
                  const id = normalize(row.dataset.id);
                  const name = normalize(row.dataset.name);
                  const match = q === "" || id.includes(q) || name.includes(q);
                  row.classList.toggle("d-none", !match);
                });
              }
              productSearch.addEventListener("input", filterProducts);
            }

            // ================= BLOG: EasyMDE + preview + submit =================
            let blogMde = null;
            let blogSlugTouched2 = false;

            const blogModalEl = document.getElementById("addBlogModal");
            const blogForm = document.getElementById("addBlogForm");

            const blogTitle = document.getElementById("blogTitle");
            const blogSlug = document.getElementById("blogSlug");
            const blogExcerpt = document.getElementById("blogExcerpt");
            const blogStatus = document.getElementById("blogStatus");

            const blogMarkdown = document.getElementById("blogMarkdown");
            const blogPreview = document.getElementById("blogPreview");

            const blogContentHtml = document.getElementById("blogContentHtml");
            const blogPublishedAt = document.getElementById("blogPublishedAt");

            const blogCoverFile = document.getElementById("blogCoverFile");
            const blogCoverUrlHidden = document.getElementById("blogCoverImageUrl");
            const blogCoverPreview = document.getElementById("blogCoverPreview");
            const blogCoverEmpty = document.getElementById("blogCoverEmpty");

            // preview ảnh bìa
            bindFilePreview(blogCoverFile, blogCoverPreview, blogCoverEmpty);

            // auto slug
            if (blogSlug) {
              blogSlug.addEventListener("input", () => {
                blogSlugTouched2 = blogSlug.value.trim().length > 0;
              });
            }
            if (blogTitle && blogSlug) {
              blogTitle.addEventListener("input", () => {
                if (!blogSlugTouched2) blogSlug.value = makeSlug(blogTitle.value);
              });
            }

                    function renderBlogPreview(md) {
          const mk = window.marked;
          if (!mk) {
            console.error("Marked chưa load. Kiểm tra lại <script src='...marked...'>");
            return;
          }
          const rawHtml = mk.parse(md || "");
          const safeHtml = DOMPurify.sanitize(rawHtml);
          blogPreview.innerHTML = safeHtml || '<div class="text-muted">Preview sẽ hiển thị tại đây.</div>';
        }


            if (blogModalEl) {
              blogModalEl.addEventListener("shown.bs.modal", () => {
                if (!blogMde && blogMarkdown) {
                  blogMde = new EasyMDE({
                    element: blogMarkdown,
                    spellChecker: false,
                    autofocus: true,
                    minHeight: "320px",
                    status: ["lines", "words"],
                    toolbar: [
                      "bold", "italic", "heading", "|",
                      "quote", "unordered-list", "ordered-list", "|",
                      "link", "image", "table", "|",
                      "preview", "side-by-side", "fullscreen", "|",
                      "guide"
                    ]
                  });

                  blogMde.codemirror.on("change", () => renderBlogPreview(blogMde.value()));
                }

                if (blogMde) {
                  blogMde.codemirror.refresh();
                  renderBlogPreview(blogMde.value());
                }
              });

              blogModalEl.addEventListener("hidden.bs.modal", () => {
                blogSlugTouched2 = false;
                if (blogForm) blogForm.reset();

                if (blogCoverUrlHidden) blogCoverUrlHidden.value = "";
                if (blogContentHtml) blogContentHtml.value = "";
                if (blogPublishedAt) blogPublishedAt.value = "";

                if (blogCoverPreview && blogCoverEmpty) {
                  blogCoverPreview.style.display = "none";
                  blogCoverPreview.removeAttribute("src");
                  blogCoverEmpty.style.display = "inline";
                }

                if (blogMde) {
                  blogMde.value("");
                  renderBlogPreview("");
                }
              });
            }

            if (blogForm) {
              blogForm.addEventListener("submit", async (e) => {
                e.preventDefault();

                const md = blogMde ? blogMde.value() : (blogMarkdown?.value || "");
                if (!md.trim()) {
                  alert("Vui lòng nhập nội dung bài viết.");
                  return;
                }

                const html = DOMPurify.sanitize(marked.parse(md));
                blogContentHtml.value = html;

                if (blogExcerpt && !blogExcerpt.value.trim()) {
                  const tmp = document.createElement("div");
                  tmp.innerHTML = html;
                  const plain = (tmp.textContent || tmp.innerText || "").trim().replace(/\s+/g, " ");
                  blogExcerpt.value = plain.length > 160 ? plain.slice(0, 160) + "..." : plain;
                }

                const st = (blogStatus?.value || "draft").toLowerCase();
                blogPublishedAt.value = (st === "published") ? new Date().toISOString() : "";

                const submitBtn = blogForm.querySelector('button[type="submit"]');
                const oldHtml = submitBtn ? submitBtn.innerHTML : null;

                const file = blogCoverFile?.files?.[0];
                if (file) {
                  if (!file.type?.startsWith("image/")) {
                    alert("Ảnh bìa phải là định dạng image/*.");
                    return;
                  }

                  if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = "Đang tải ảnh...";
                  }

                  try {
                    const publicId = `blog-${makeSlug(blogSlug?.value || blogTitle?.value || "post")}-${Date.now()}`;
                    const url = await uploadToCloudinaryUnsigned(file, publicId);
                    blogCoverUrlHidden.value = url;
                  } catch (err) {
                    console.error(err);
                    alert(err?.message || "Upload ảnh bìa thất bại.");
                    if (submitBtn) {
                      submitBtn.disabled = false;
                      submitBtn.innerHTML = oldHtml;
                    }
                    return;
                  } finally {
                    if (submitBtn) {
                      submitBtn.disabled = false;
                      submitBtn.innerHTML = oldHtml || "Lưu bài viết";
                    }
                  }
                }

                blogForm.submit();
              });
            }
          });
                  // ================= BLOG EDIT: open modal + preview + submit =================
        let editBlogMde = null;
        let editSlugTouched = false;

        const editBlogModalEl = document.getElementById("editBlogModal");
        const editBlogForm = document.getElementById("editBlogForm");

        const editBlogId = document.getElementById("editBlogId");
        const editBlogTitle = document.getElementById("editBlogTitle");
        const editBlogSlug = document.getElementById("editBlogSlug");
        const editBlogExcerpt = document.getElementById("editBlogExcerpt");
        const editBlogStatus = document.getElementById("editBlogStatus");

        const editBlogMarkdown = document.getElementById("editBlogMarkdown");
        const editBlogPreview = document.getElementById("editBlogPreview");

        const editBlogContentHtml = document.getElementById("editBlogContentHtml");

        const editBlogCoverFile = document.getElementById("editBlogCoverFile");
        const editBlogCoverUrlHidden = document.getElementById("editBlogCoverImageUrl");
        const editBlogCoverPreview = document.getElementById("editBlogCoverPreview");
        const editBlogCoverEmpty = document.getElementById("editBlogCoverEmpty");
        const btnClearEditCover = document.getElementById("btnClearEditCover");

        function renderMarkdownPreview(md, targetEl) {
          const mk = window.marked;
          if (!mk) return;
          const rawHtml = mk.parse(md || "");
          const safeHtml = DOMPurify.sanitize(rawHtml);
          targetEl.innerHTML = safeHtml || '<div class="text-muted">Preview sẽ hiển thị tại đây.</div>';
        }

        function htmlToPlainText(html) {
          const div = document.createElement("div");
          div.innerHTML = html || "";
          return (div.textContent || div.innerText || "").trim();
        }

        if (editBlogModalEl) {
          editBlogModalEl.addEventListener("shown.bs.modal", () => {
            if (!editBlogMde && editBlogMarkdown) {
              editBlogMde = new EasyMDE({
                element: editBlogMarkdown,
                spellChecker: false,
                autofocus: true,
                minHeight: "320px",
                status: ["lines", "words"],
                toolbar: [
                  "bold", "italic", "heading", "|",
                  "quote", "unordered-list", "ordered-list", "|",
                  "link", "image", "table", "|",
                  "preview", "side-by-side", "fullscreen", "|",
                  "guide"
                ]
              });
              editBlogMde.codemirror.on("change", () => renderMarkdownPreview(editBlogMde.value(), editBlogPreview));
            }

            if (editBlogMde) {
              editBlogMde.codemirror.refresh();
              renderMarkdownPreview(editBlogMde.value(), editBlogPreview);
            }
          });

          editBlogModalEl.addEventListener("hidden.bs.modal", () => {
            editSlugTouched = false;
            if (editBlogForm) editBlogForm.reset();

            if (editBlogCoverUrlHidden) editBlogCoverUrlHidden.value = "";
            if (editBlogContentHtml) editBlogContentHtml.value = "";

            if (editBlogCoverPreview && editBlogCoverEmpty) {
              editBlogCoverPreview.style.display = "none";
              editBlogCoverPreview.removeAttribute("src");
              editBlogCoverEmpty.style.display = "inline";
            }

            if (editBlogMde) {
              editBlogMde.value("");
              renderMarkdownPreview("", editBlogPreview);
            }
          });
        }

        if (editBlogSlug) {
          editBlogSlug.addEventListener("input", () => {
            editSlugTouched = editBlogSlug.value.trim().length > 0;
          });
        }
        if (editBlogTitle && editBlogSlug) {
          editBlogTitle.addEventListener("input", () => {
            if (!editSlugTouched) editBlogSlug.value = makeSlug(editBlogTitle.value);
          });
        }

        bindFilePreview(editBlogCoverFile, editBlogCoverPreview, editBlogCoverEmpty);

        if (btnClearEditCover) {
          btnClearEditCover.addEventListener("click", () => {
            if (editBlogCoverFile) editBlogCoverFile.value = "";
            if (editBlogCoverUrlHidden) editBlogCoverUrlHidden.value = "";
            setPreviewUrl("", editBlogCoverPreview, editBlogCoverEmpty);
          });
        }

        $$(".btn-edit-blog").forEach(btn => {
          btn.addEventListener("click", () => {
            const id = btn.dataset.id;
            const scriptEl = document.getElementById(`blog-data-${id}`);
            if (!scriptEl) return;

            const data = JSON.parse(scriptEl.textContent || "{}");

            if (editBlogId) editBlogId.value = data.id || "";
            if (editBlogTitle) editBlogTitle.value = data.title || "";
            if (editBlogSlug) editBlogSlug.value = data.slug || "";
            if (editBlogExcerpt) editBlogExcerpt.value = data.excerpt || "";
            if (editBlogStatus) editBlogStatus.value = (data.status || "draft").toLowerCase();

            if (editBlogCoverUrlHidden) editBlogCoverUrlHidden.value = data.coverImageUrl || "";
            setPreviewUrl(data.coverImageUrl || "", editBlogCoverPreview, editBlogCoverEmpty);

            const mdFallback = htmlToPlainText(data.contentHtml || "");
            if (editBlogMde) {
              editBlogMde.value(mdFallback);
              renderMarkdownPreview(editBlogMde.value(), editBlogPreview);
            } else {
              if (editBlogMarkdown) editBlogMarkdown.value = mdFallback;
            }
          });
        });

        if (editBlogForm) {
          editBlogForm.addEventListener("submit", async (e) => {
            e.preventDefault();

            const md = editBlogMde ? editBlogMde.value() : (editBlogMarkdown?.value || "");
            if (!md.trim()) {
              alert("Vui lòng nhập nội dung bài viết.");
              return;
            }

            const html = DOMPurify.sanitize(marked.parse(md));
            editBlogContentHtml.value = html;

            if (editBlogExcerpt && !editBlogExcerpt.value.trim()) {
              const tmp = document.createElement("div");
              tmp.innerHTML = html;
              const plain = (tmp.textContent || tmp.innerText || "").trim().replace(/\s+/g, " ");
              editBlogExcerpt.value = plain.length > 160 ? plain.slice(0, 160) + "..." : plain;
            }

            const submitBtn = editBlogForm.querySelector('button[type="submit"]');
            const oldHtml = submitBtn ? submitBtn.innerHTML : null;

            const file = editBlogCoverFile?.files?.[0];
            if (file) {
              if (!file.type?.startsWith("image/")) {
                alert("Ảnh bìa phải là định dạng image/*.");
                return;
              }

              if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = "Đang tải ảnh...";
              }

              try {
                const publicId = `blog-${makeSlug(editBlogSlug?.value || editBlogTitle?.value || "post")}-${Date.now()}`;
                const url = await uploadToCloudinaryUnsigned(file, publicId);
                editBlogCoverUrlHidden.value = url;
              } catch (err) {
                console.error(err);
                alert(err?.message || "Upload ảnh bìa thất bại.");
                if (submitBtn) {
                  submitBtn.disabled = false;
                  submitBtn.innerHTML = oldHtml;
                }
                return;
              } finally {
                if (submitBtn) {
                  submitBtn.disabled = false;
                  submitBtn.innerHTML = oldHtml || "Lưu thay đổi";
                }
              }
            }

            editBlogForm.submit();
          });
                  // ===== User: search filter =====
        const userSearch = document.getElementById("userSearch");
        if (userSearch) {
          const normalize = (s) => (s || "").toString().trim().toLowerCase();

          function filterUsers() {
            const q = normalize(userSearch.value);
            document.querySelectorAll("tr.user-row").forEach(row => {
              const id = normalize(row.dataset.id);
              const name = normalize(row.dataset.name);
              const email = normalize(row.dataset.email);
              const match = q === "" || id.includes(q) || name.includes(q) || email.includes(q);
              row.classList.toggle("d-none", !match);
            });
          }

          userSearch.addEventListener("input", filterUsers);
        }

        }

        })();
    </script>




</body>
</html>