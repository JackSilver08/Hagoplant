@model Hagoplant.ViewModels.AdminDashboardVm
@@model Hagoplant.ViewModels.HomeIndexVm
@using System.Linq

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hago Tree - Quản trị hệ thống</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts: Francois One -->
    <link href="https://fonts.googleapis.com/css2?family=Francois+One&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Francois One', sans-serif;
            background-color: #f8f5f0;
            color: #333;
        }
        .text-primary-custom {
            color: #579a62 !important;
        }
        .bg-primary-custom {
            background-color: #579a62 !important;
        }
        .btn-primary-custom {
            background-color: #579a62;
            border-color: #579a62;
            color: white;
        }
        .btn-primary-custom:hover {
            background-color: #478152;
            border-color: #478152;
        }
        .btn-secondary-custom {
            background-color: transparent;
            border-color: #579a62;
            color: #579a62;
        }
        .btn-secondary-custom:hover {
            background-color: rgba(87, 154, 98, 0.1);
        }

        /* Header Admin */
        .admin-header {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            height: 80px;
        }
        .admin-logo {
            width: 50px;
            height: 50px;
        }

        /* Sidebar Admin */
        .admin-sidebar {
            background: linear-gradient(180deg, #2d2d2d 0%, #1a1a1a 100%);
            color: white;
            min-height: calc(100vh - 80px);
            box-shadow: 3px 0 15px rgba(0, 0, 0, 0.1);
        }
        .admin-sidebar .nav-link {
            color: #ddd;
            padding: 12px 20px;
            border-radius: 8px;
            margin: 5px 10px;
            transition: all 0.3s ease;
        }
        .admin-sidebar .nav-link:hover {
            background-color: rgba(87, 154, 98, 0.2);
            color: white;
            transform: translateX(5px);
        }
        .admin-sidebar .nav-link.active {
            background-color: #579a62;
            color: white;
        }
        .admin-sidebar .nav-link i {
            width: 25px;
        }

        /* Content area */
        .admin-content {
            padding: 30px;
            min-height: calc(100vh - 80px);
            background-color: #f8f5f0;
        }

        /* Cards */
        .admin-card {
            border: 2px solid #d4af37;
            background-color: #ffffff;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .admin-card-header {
            background: linear-gradient(to right, #579a62, #6bbf7a);
            color: white;
            padding: 15px 20px;
            border-bottom: 2px solid #d4af37;
        }

        /* Stats Cards */
        .stat-card {
            text-align: center;
            padding: 25px 15px;
            border-radius: 15px;
            color: white;
            margin-bottom: 20px;
        }
        .stat-card.revenue { background: linear-gradient(135deg, #4e54c8, #8f94fb); }
        .stat-card.users { background: linear-gradient(135deg, #11998e, #38ef7d); }
        .stat-card.products { background: linear-gradient(135deg, #f46b45, #eea849); }
        .stat-card.orders { background: linear-gradient(135deg, #8E2DE2, #4A00E0); }
        .stat-card i { font-size: 2.5rem; margin-bottom: 15px; opacity: 0.9; }
        .stat-card .number { font-size: 2.2rem; font-weight: bold; margin-bottom: 5px; }
        .stat-card .label { font-size: 0.9rem; opacity: 0.9; }

        /* Table search bar */
        .table-search {
            max-width: 300px;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        .empty-state i {
            font-size: 4rem;
            color: #ddd;
            margin-bottom: 20px;
        }

        @@media (max-width: 768px) {
            .admin-content { padding: 15px; }
            .stat-card .number { font-size: 1.8rem; }
            .table-search { max-width: 100%; margin-bottom: 15px; }
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header class="admin-header d-flex align-items-center px-4">
        <img src="https://via.placeholder.com/50" alt="Logo" class="admin-logo me-3">
        <h4 class="text-white mb-0">Hago Tree - Quản trị</h4>
        <div class="ms-auto">
            <i class="fas fa-user-circle text-white fs-3"></i>
        </div>
    </header>

    <div class="container-fluid p-0">
        <div class="row g-0">
            <!-- Sidebar -->
            <div class="col-lg-2 col-md-3">
                <div class="admin-sidebar p-3">
                    <ul class="nav flex-column">
                        <li class="nav-item"><a class="nav-link active" href="#dashboard"><i class="fas fa-home"></i> Tổng quan</a></li>
                        <li class="nav-item"><a class="nav-link" href="#users"><i class="fas fa-users"></i> Người dùng</a></li>
                        <li class="nav-item"><a class="nav-link" href="#products"><i class="fas fa-tree"></i> Sản phẩm</a></li>
                        <li class="nav-item"><a class="nav-link" href="#orders"><i class="fas fa-shopping-cart"></i> Đơn hàng</a></li>
                        <li class="nav-item"><a class="nav-link" href="#blog"><i class="fas fa-blog"></i> Blog</a></li>
                        <li class="nav-item"><a class="nav-link" href="#reports"><i class="fas fa-chart-bar"></i> Báo cáo</a></li>
                    </ul>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-lg-10 col-md-9">
                <div class="admin-content">

                    <!-- Dashboard -->
                    <section id="dashboard" class="section-content">
                        <h2 class="text-primary-custom mb-4">Tổng quan hệ thống</h2>
                        <div class="row mb-5">
                            <div class="col-md-3"><div class="stat-card revenue"><i class="fas fa-money-bill-wave"></i><div class="number">0 ₫</div><div class="label">Doanh thu tháng</div></div></div>
                            <div class="col-md-3"><div class="stat-card users"><i class="fas fa-users"></i><div class="number">0</div><div class="label">Người dùng</div></div></div>
                            <div class="col-md-3"><div class="stat-card products"><i class="fas fa-tree"></i><div class="number">0</div><div class="label">Sản phẩm</div></div></div>
                            <div class="col-md-3"><div class="stat-card orders"><i class="fas fa-shopping-cart"></i><div class="number">0</div><div class="label">Đơn hàng</div></div></div>
                        </div>

                        <div class="row">
                            <div class="col-md-8 mb-4">
                                <div class="admin-card">
                                    <div class="admin-card-header"><h5 class="mb-0">Doanh thu 6 tháng gần nhất</h5></div>
                                    <div class="card-body p-4">
                                        <div class="empty-state"><i class="fas fa-chart-line"></i><p>Chưa có dữ liệu doanh thu</p></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-4">
                                <div class="admin-card">
                                    <div class="admin-card-header"><h5 class="mb-0">Phân loại sản phẩm</h5></div>
                                    <div class="card-body p-4">
                                        <div class="empty-state"><i class="fas fa-chart-pie"></i><p>Chưa có dữ liệu sản phẩm</p></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Quản lý Người dùng -->
                    <section id="users" class="section-content d-none">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2 class="text-primary-custom mb-0">Quản lý người dùng</h2>
                            <button class="btn btn-primary-custom" data-bs-toggle="modal" data-bs-target="#addUserModal">
                                <i class="fas fa-user-plus me-2"></i>Thêm người dùng
                            </button>
                        </div>

                        <div class="admin-card">
                            <div class="admin-card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-users me-2"></i>Danh sách người dùng</h5>
                                <input type="text" class="form-control table-search" placeholder="Tìm kiếm theo tên, email...">
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle">
                                        <thead class="table-light">
                                            <tr>
                                                <th>ID</th>
                                                <th>Họ tên</th>
                                                <th>Email</th>
                                                <th>Số điện thoại</th>
                                                <th>Ngày đăng ký</th>
                                                <th>Thao tác</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td colspan="6">
                                                    <div class="empty-state py-5">
                                                        <i class="fas fa-users"></i>
                                                        <p>Chưa có người dùng nào</p>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Quản lý Sản phẩm -->
                    <section id="products" class="section-content d-none">

                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2 class="text-primary-custom mb-0">Quản lý sản phẩm</h2>
                            <button class="btn btn-primary-custom"
                                    data-bs-toggle="modal"
                                    data-bs-target="#addProductModal">
                                <i class="fas fa-plus me-2"></i>Thêm sản phẩm
                            </button>
                        </div>

                        <div class="admin-card">
                            <div class="admin-card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-tree me-2"></i>Danh sách sản phẩm
                                </h5>
                                <input id="productSearch"
                                       type="text"
                                       class="form-control table-search"
                                       placeholder="Tìm theo tên, slug, id..." />
                            </div>

                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="min-width:180px;">ID</th>
                                                <th style="width:90px;">Ảnh</th>
                                                <th style="min-width:220px;">Tên sản phẩm</th>
                                                <th style="min-width:200px;">Slug</th>
                                                <th style="min-width:120px;">Giá</th>
                                                <th style="min-width:120px;">Giá sale</th>
                                                <th style="min-width:110px;">Đang bán</th>
                                                <th style="min-width:110px;">Nổi bật</th>
                                                <th style="min-width:170px;">Ngày tạo</th>
                                                <th style="min-width:140px;">Thao tác</th>
                                            </tr>
                                        </thead>

                                        <tbody>
                                            @if (Model?.Products == null || Model.Products.Count == 0)
                                            {
                                                <tr>
                                                    <td colspan="10">
                                                        <div class="empty-state py-5 text-center">
                                                            <i class="fas fa-tree"></i>
                                                            <p class="mb-0">Chưa có sản phẩm nào</p>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                            else
                                            {
                                                foreach (var p in Model.Products)
                                                {
                                                    <tr>
                                                        <td class="text-muted small">@p.Id</td>

                                                        <td>
                                                            @if (!string.IsNullOrWhiteSpace(p.ImageUrl))
                                                            {
                                                                <img src="@p.ImageUrl"
                                                                     class="rounded"
                                                                     style="width:60px;height:60px;object-fit:cover;" />
                                                            }
                                                            else
                                                            {
                                                                <span class="text-muted small">No image</span>
                                                            }
                                                </td>

                                                <td class="fw-semibold">@p.Name</td>
                                                <td class="text-muted">@p.Slug</td>

                                                <td>@string.Format("{0:N0}", p.Price)</td>
                                                <td>
                                                    @(p.SalePrice.HasValue
                                                                                                        ? string.Format("{0:N0}", p.SalePrice.Value)
                                                                                                        : "-")
                                                        </td>

                                                        <td>
                                                            @if (p.IsActive)
                                                            {
                                                                <span class="badge bg-success">Active</span>
                                                            }
                                                            else
                                                            {
                                                                <span class="badge bg-secondary">Off</span>
                                                            }
                                                        </td>

                                                        <td>
                                                            @if (p.IsFeatured)
                                                            {
                                                                <span class="badge bg-warning text-dark">Yes</span>
                                                            }
                                                            else
                                                            {
                                                                <span class="badge bg-secondary">No</span>
                                                            }
                                                        </td>

                                                        <td class="text-muted">
                                                            @p.CreatedAt.ToLocalTime()
                                                            .ToString("dd/MM/yyyy HH:mm")
                                                        </td>

                                                        <td>
                                                            <!-- Edit -->
                                                            <button type="button"
                                                                    class="btn btn-sm btn-outline-primary btn-edit-product"
                                                                    data-bs-toggle="modal"
                                                                    data-bs-target="#editProductModal"
                                                                    data-id="@p.Id"
                                                                    data-name="@p.Name"
                                                                    data-slug="@p.Slug"
                                                                    data-description="@p.Description"
                                                                    data-price="@p.Price"
                                                                    data-saleprice="@(p.SalePrice?.ToString() ?? "")"
                                                                    data-imageurl="@p.ImageUrl"
                                                                    data-isactive="@p.IsActive"
                                                                    data-isfeatured="@p.IsFeatured">
                                                                <i class="fas fa-pen"></i>
                                                            </button>

                                                            <!-- Delete -->
                                                            <form method="post"
                                                                  action="/Admin/DeleteProduct"
                                                                  class="d-inline"
                                                                  onsubmit="return confirm('Xóa sản phẩm này?');">
                                                                @Html.AntiForgeryToken()
                                                                <input type="hidden" name="id" value="@p.Id" />
                                                                <button type="submit"
                                                                        class="btn btn-sm btn-outline-danger ms-1">
                                                                    <i class="fas fa-trash"></i>
                                                                </button>
                                                            </form>
                                                        </td>
                                                    </tr>
                                                }
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </section>



                    <!-- Quản lý Đơn hàng -->
                    <section id="orders" class="section-content d-none">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2 class="text-primary-custom mb-0">Quản lý đơn hàng</h2>
                            <button class="btn btn-primary-custom" disabled>
                                <i class="fas fa-plus me-2"></i>Thêm đơn hàng (tính năng sắp có)
                            </button>
                        </div>

                        <div class="admin-card">
                            <div class="admin-card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Danh sách đơn hàng</h5>
                                <input type="text" class="form-control table-search" placeholder="Tìm kiếm theo mã đơn, khách hàng...">
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Mã đơn</th>
                                                <th>Khách hàng</th>
                                                <th>Ngày đặt</th>
                                                <th>Tổng tiền</th>
                                                <th>Trạng thái</th>
                                                <th>Thao tác</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td colspan="6">
                                                    <div class="empty-state py-5">
                                                        <i class="fas fa-shopping-cart"></i>
                                                        <p>Chưa có đơn hàng nào</p>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Quản lý Blog -->
                    <section id="blog" class="section-content d-none">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2 class="text-primary-custom mb-0">Quản lý bài viết blog</h2>
                            <button class="btn btn-primary-custom" data-bs-toggle="modal" data-bs-target="#addBlogModal">
                                <i class="fas fa-plus me-2"></i>Viết bài mới
                            </button>
                        </div>

                        <div class="admin-card">
                            <div class="admin-card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-blog me-2"></i>Danh sách bài viết</h5>
                                <input type="text" class="form-control table-search" placeholder="Tìm kiếm theo tiêu đề, tác giả...">
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle">
                                        <thead class="table-light">
                                            <tr>
                                                <th>ID</th>
                                                <th>Tiêu đề</th>
                                                <th>Tác giả</th>
                                                <th>Ngày đăng</th>
                                                <th>Lượt xem</th>
                                                <th>Thao tác</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td colspan="6">
                                                    <div class="empty-state py-5">
                                                        <i class="fas fa-blog"></i>
                                                        <p>Chưa có bài viết nào</p>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Báo cáo -->
                    <section id="reports" class="section-content d-none">
                        <h2 class="text-primary-custom mb-4">Báo cáo & Thống kê</h2>
                        <div class="row">
                            <div class="col-12">
                                <div class="admin-card">
                                    <div class="admin-card-header"><h5 class="mb-0">Thống kê chi tiết</h5></div>
                                    <div class="card-body p-5">
                                        <div class="empty-state">
                                            <i class="fas fa-chart-bar"></i>
                                            <p>Chưa có dữ liệu để hiển thị báo cáo</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                </div>
            </div>
        </div>
    </div>
    <!-- Modal Thêm sản phẩm -->
    <div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary-custom text-white">
                    <h5 class="modal-title" id="addProductModalLabel">
                        <i class="fas fa-plus me-2"></i>Thêm sản phẩm
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Đóng"></button>
                </div>

                <form method="post"
                      action="@Url.Action("CreateProduct", "Admin")"
                      id="addProductForm"
                      novalidate>
                    @Html.AntiForgeryToken()

                    <div class="modal-body">
                        <input type="hidden" name="Id" value="" />
                        <input type="hidden" name="ImageUrl" id="productImageUrlHidden" />
                        <input type="hidden" name="CreatedAt" value="" />

                        <div class="row g-3">
                            <div class="col-md-8">
                                <label class="form-label">Tên sản phẩm <span class="text-danger">*</span></label>
                                <input type="text"
                                       class="form-control"
                                       id="productName"
                                       name="Name"
                                       required
                                       maxlength="200"
                                       placeholder="Ví dụ: Cây Trầu Bà Leo Cột" />
                                <div class="invalid-feedback">Vui lòng nhập tên sản phẩm.</div>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Slug <span class="text-danger">*</span></label>
                                <input type="text"
                                       class="form-control"
                                       id="productSlug"
                                       name="Slug"
                                       required
                                       maxlength="250"
                                       placeholder="cay-trau-ba-leo-cot" />
                                <div class="invalid-feedback">Vui lòng nhập slug.</div>
                                <small class="text-muted">Tự tạo từ tên, bạn có thể sửa lại.</small>
                            </div>

                            <div class="col-12">
                                <label class="form-label">Mô tả</label>
                                <textarea class="form-control"
                                          id="productDescription"
                                          name="Description"
                                          rows="4"
                                          placeholder="Mô tả ngắn về sản phẩm..."></textarea>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Giá gốc (Price) <span class="text-danger">*</span></label>
                                <input type="number"
                                       class="form-control"
                                       id="productPrice"
                                       name="Price"
                                       required
                                       step="0.01"
                                       min="0"
                                       placeholder="0" />
                                <div class="invalid-feedback">Vui lòng nhập giá hợp lệ.</div>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Giá sale (SalePrice)</label>
                                <input type="number"
                                       class="form-control"
                                       id="productSalePrice"
                                       name="SalePrice"
                                       step="0.01"
                                       min="0"
                                       placeholder="(không bắt buộc)" />
                                <small class="text-muted">Có thể để trống.</small>
                            </div>

                            <!-- Trạng thái: KHÔNG hidden boolean -->
                            <div class="col-md-4">
                                <label class="form-label">Trạng thái</label>
                                <div class="d-flex gap-3 align-items-center mt-1">
                                    <div class="form-check">
                                        <input class="form-check-input"
                                               type="checkbox"
                                               id="productIsActive"
                                               name="IsActive"
                                               value="true"
                                               checked />
                                        <label class="form-check-label" for="productIsActive">Đang bán</label>
                                    </div>

                                    <div class="form-check">
                                        <input class="form-check-input"
                                               type="checkbox"
                                               id="productIsFeatured"
                                               name="IsFeatured"
                                               value="true" />
                                        <label class="form-check-label" for="productIsFeatured">Nổi bật</label>
                                    </div>
                                </div>
                            </div>

                            <!-- Upload ảnh -> Cloudinary (JS upload và set ImageUrl hidden) -->
                            <div class="col-md-8">
                                <label class="form-label">Ảnh sản phẩm</label>
                                <input type="file"
                                       class="form-control"
                                       id="productImageFile"
                                       accept="image/*" />
                                <small class="text-muted">Chọn ảnh để upload lên Cloudinary; link sẽ tự lưu vào database.</small>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Xem trước ảnh</label>
                                <div class="border rounded p-2 bg-light d-flex align-items-center justify-content-center" style="height: 120px;">
                                    <img id="productImagePreview" alt="preview" style="max-height:110px;max-width:100%;display:none;" />
                                    <span id="productImageEmpty" class="text-muted">Chưa có ảnh</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-primary-custom">
                            <i class="fas fa-save me-2"></i>Lưu sản phẩm
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Sửa sản phẩm -->
    <div class="modal fade" id="editProductModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary-custom text-white">
                    <h5 class="modal-title"><i class="fas fa-pen me-2"></i>Sửa sản phẩm</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <form method="post"
                      action="@Url.Action("UpdateProduct", "Admin")"
                      id="editProductForm"
                      novalidate>
                    @Html.AntiForgeryToken()

                    <input type="hidden" name="id" id="editId" />

                    <!-- JS sẽ set URL ảnh mới vào đây (nếu upload ảnh mới) -->
                    <input type="hidden" name="ImageUrl" id="editImageUrlHidden" />

                    <!-- Luôn giữ URL ảnh hiện tại để server có thể giữ lại nếu không upload mới -->
                    <input type="hidden" name="ExistingImageUrl" id="editExistingImageUrl" />

                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-8">
                                <label class="form-label">Tên sản phẩm *</label>
                                <input type="text" class="form-control" id="editName" name="Name" required />
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Slug *</label>
                                <input type="text" class="form-control" id="editSlug" name="Slug" required />
                            </div>

                            <div class="col-12">
                                <label class="form-label">Mô tả</label>
                                <textarea class="form-control" id="editDescription" name="Description" rows="4"></textarea>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Giá *</label>
                                <input type="number" class="form-control" id="editPrice" name="Price" step="0.01" min="0" required />
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Giá sale</label>
                                <input type="number" class="form-control" id="editSalePrice" name="SalePrice" step="0.01" min="0" />
                            </div>

                            <!-- Trạng thái: KHÔNG hidden boolean -->
                            <div class="col-md-4">
                                <label class="form-label">Trạng thái</label>
                                <div class="d-flex gap-3 align-items-center mt-1">
                                    <div class="form-check">
                                        <input class="form-check-input"
                                               type="checkbox"
                                               id="editIsActive"
                                               name="IsActive"
                                               value="true" />
                                        <label class="form-check-label" for="editIsActive">Đang bán</label>
                                    </div>

                                    <div class="form-check">
                                        <input class="form-check-input"
                                               type="checkbox"
                                               id="editIsFeatured"
                                               name="IsFeatured"
                                               value="true" />
                                        <label class="form-check-label" for="editIsFeatured">Nổi bật</label>
                                    </div>
                                </div>
                            </div>

                            <!-- Chọn ảnh mới (nếu cần). JS upload và set editImageUrlHidden -->
                            <div class="col-md-8">
                                <label class="form-label">Đổi ảnh sản phẩm (nếu cần)</label>
                                <input type="file"
                                       class="form-control"
                                       id="editImageFile"
                                       accept="image/*" />
                                <small class="text-muted">Nếu không chọn ảnh mới, hệ thống sẽ giữ ảnh hiện tại.</small>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Xem trước ảnh</label>
                                <div class="border rounded p-2 bg-light d-flex align-items-center justify-content-center" style="height: 120px;">
                                    <img id="editImgPreview" alt="preview" style="max-height:110px;max-width:100%;display:none;" />
                                    <span id="editImgEmpty" class="text-muted">Chưa có ảnh</span>
                                </div>
                            </div>

                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-primary-custom">
                            <i class="fas fa-save me-2"></i>Cập nhật
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- Modal ví dụ (có thể mở rộng thêm) -->
    <div class="modal fade" id="addUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary-custom text-white">
                    <h5 class="modal-title">Thêm người dùng mới</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Form thêm người dùng sẽ được kết nối API sau...</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary-custom">Lưu</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        (() => {
          "use strict";

          // ====== Cloudinary unsigned config ======
          const CLOUD_NAME = "dksk0yoma";      // ví dụ: "hagotree"
          const UPLOAD_PRESET = "hago_unsigned_products";    // đúng preset bạn tạo

          // ====== Helpers ======
          const $  = (sel, root = document) => root.querySelector(sel);
          const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

          function makeSlug(text) {
            return (text || "")
              .toString().trim().toLowerCase()
              .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
              .replace(/đ/g, "d")
              .replace(/[^a-z0-9\s-]/g, "")
              .replace(/\s+/g, "-")
              .replace(/-+/g, "-")
              .replace(/^-+|-+$/g, "");
          }

          function setPreviewUrl(url, imgEl, emptyEl) {
            if (!imgEl || !emptyEl) return;
            const u = (url || "").trim();

            if (!u) {
              imgEl.style.display = "none";
              imgEl.removeAttribute("src");
              emptyEl.style.display = "inline";
              return;
            }

            imgEl.src = u;
            imgEl.style.display = "block";
            emptyEl.style.display = "none";

            imgEl.onerror = () => {
              imgEl.style.display = "none";
              imgEl.removeAttribute("src");
              emptyEl.style.display = "inline";
            };
          }

          function bindFilePreview(fileInput, imgEl, emptyEl) {
            if (!fileInput || !imgEl || !emptyEl) return;

            fileInput.addEventListener("change", () => {
              const f = fileInput.files && fileInput.files[0];
              if (!f || !f.type?.startsWith("image/")) {
                setPreviewUrl("", imgEl, emptyEl);
                return;
              }
              imgEl.src = URL.createObjectURL(f);
              imgEl.style.display = "block";
              emptyEl.style.display = "none";
            });
          }

          async function uploadToCloudinaryUnsigned(file, publicIdOptional) {
            const endpoint = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`;
            const fd = new FormData();
            fd.append("file", file);
            fd.append("upload_preset", UPLOAD_PRESET);

            // (tuỳ chọn) đặt public_id để dễ quản trị trên Cloudinary
            // Không cần secret cho unsigned upload.
            if (publicIdOptional) fd.append("public_id", publicIdOptional);

            const res = await fetch(endpoint, { method: "POST", body: fd });
            const data = await res.json().catch(() => ({}));

            if (!res.ok) {
              const msg = data?.error?.message || "Upload Cloudinary thất bại.";
              throw new Error(msg);
            }

            if (!data.secure_url) throw new Error("Không nhận được secure_url từ Cloudinary.");
            return data.secure_url;
          }

          // Upload trước khi submit form
          function wireUploadBeforeSubmit({
            formId,
            fileInputId,
            hiddenUrlId,
            nameForPublicId // dùng slug để đặt public_id (tuỳ chọn)
          }) {
            const form = document.getElementById(formId);
            const fileInput = document.getElementById(fileInputId);
            const hiddenUrl = document.getElementById(hiddenUrlId);
            if (!form || !fileInput || !hiddenUrl) return;

            form.addEventListener("submit", async (e) => {
              const file = fileInput.files && fileInput.files[0];
              if (!file) return; // không chọn file => submit bình thường (EDIT sẽ giữ URL cũ)

              if (!file.type?.startsWith("image/")) {
                e.preventDefault();
                alert("Vui lòng chọn đúng định dạng ảnh (image/*).");
                return;
              }

              e.preventDefault();

              // Disable nút submit để tránh bấm nhiều lần
              const submitBtn = form.querySelector('button[type="submit"]');
              const oldHtml = submitBtn ? submitBtn.innerHTML : null;
              if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = "Đang tải ảnh...";
              }

              try {
                const base = nameForPublicId ? makeSlug(nameForPublicId()) : "product";
                const publicId = `${base}-${Date.now()}`; // tránh trùng
                const url = await uploadToCloudinaryUnsigned(file, publicId);

                hiddenUrl.value = url;
                form.submit();
              } catch (err) {
                console.error(err);
                alert(err?.message || "Upload ảnh thất bại. Vui lòng thử lại.");
                if (submitBtn) {
                  submitBtn.disabled = false;
                  submitBtn.innerHTML = oldHtml;
                }
              }
            });
          }

          document.addEventListener("DOMContentLoaded", () => {
            // ===== Sidebar sections (giữ nếu bạn vẫn dùng) =====
            function showSection(sectionId) {
              $$(".section-content").forEach(s => s.classList.add("d-none"));
              const section = document.getElementById(sectionId);
              if (section) section.classList.remove("d-none");

              $$(".admin-sidebar .nav-link").forEach(l => l.classList.remove("active"));
              const activeLink = $(`.admin-sidebar .nav-link[href="#${sectionId}"]`);
              if (activeLink) activeLink.classList.add("active");
            }

            $$(".admin-sidebar .nav-link").forEach(link => {
              link.addEventListener("click", (e) => {
                e.preventDefault();
                const id = (link.getAttribute("href") || "").replace("#", "");
                if (id) showSection(id);
              });
            });

            // ===== Auto slug (ADD) =====
            const nameInput = $("#productName");
            const slugInput = $("#productSlug");
            let slugTouched = false;

            if (slugInput) {
              slugInput.addEventListener("input", () => {
                slugTouched = slugInput.value.trim().length > 0;
              });
            }
            if (nameInput && slugInput) {
              nameInput.addEventListener("input", () => {
                if (!slugTouched) slugInput.value = makeSlug(nameInput.value);
              });
            }

            // ===== Preview file =====
            bindFilePreview($("#productImageFile"), $("#productImagePreview"), $("#productImageEmpty"));
            bindFilePreview($("#editImageFile"), $("#editImgPreview"), $("#editImgEmpty"));

            // ===== Fill EDIT modal từ data-* =====
            $$(".btn-edit-product").forEach(btn => {
              btn.addEventListener("click", () => {
                const d = btn.dataset;

                $("#editId").value = d.id || "";
                $("#editName").value = d.name || "";
                $("#editSlug").value = d.slug || "";
                $("#editDescription").value = d.description || "";
                $("#editPrice").value = d.price || "0";
                $("#editSalePrice").value = d.saleprice || "";

                $("#editIsActive").checked = (d.isactive === "True" || d.isactive === "true");
                $("#editIsFeatured").checked = (d.isfeatured === "True" || d.isfeatured === "true");

                const currentUrl = d.imageurl || "";

                // giữ URL cũ để submit nếu không chọn file mới
                if ($("#editExistingImageUrl")) $("#editExistingImageUrl").value = currentUrl;
                if ($("#editImageUrlHidden")) $("#editImageUrlHidden").value = currentUrl;

                // reset file input để không dính file lần trước
                const editFile = $("#editImageFile");
                if (editFile) editFile.value = "";

                // preview ảnh hiện tại
                setPreviewUrl(currentUrl, $("#editImgPreview"), $("#editImgEmpty"));
              });
            });

            // ===== Upload before submit (ADD) =====
            wireUploadBeforeSubmit({
              formId: "addProductForm",
              fileInputId: "productImageFile",
              hiddenUrlId: "productImageUrlHidden",
              nameForPublicId: () => ($("#productSlug")?.value || $("#productName")?.value || "product")
            });

            // ===== Upload before submit (EDIT) =====
            wireUploadBeforeSubmit({
              formId: "editProductForm",
              fileInputId: "editImageFile",
              hiddenUrlId: "editImageUrlHidden",
              nameForPublicId: () => ($("#editSlug")?.value || $("#editName")?.value || "product")
            });
          });
        })();
    </script>



</body>
</html>